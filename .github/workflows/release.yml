name: Release Binaries

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tags:
        description: 'Comma-separated tags (e.g., v1.0.0,latest)'
        required: true
        default: 'latest'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Build wrappers
        run: |
          mkdir -p release

          # Linux amd64
          cp posix/sto-plugin-linux-amd64 sto-plugin-binary
          GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -ldflags "-s -w" -o release/sto-plugin-linux-amd64
          # Linux arm64  
          cp posix/sto-plugin-linux-arm64 sto-plugin-binary
          GOOS=linux GOARCH=arm64 CGO_ENABLED=0 go build -ldflags "-s -w" -o release/sto-plugin-linux-arm64
          # Darwin arm64
          cp posix/sto-plugin-darwin-arm64 sto-plugin-binary
          GOOS=darwin GOARCH=arm64 CGO_ENABLED=0 go build -ldflags "-s -w" -o release/sto-plugin-darwin-arm64

      - name: Compress with zstd
        run: |
          sudo apt-get update && sudo apt-get install -y zstd
          zstd release/sto-plugin-linux-amd64
          zstd release/sto-plugin-linux-arm64
          zstd release/sto-plugin-darwin-arm64

      - name: Create releases for all tags
        run: |
          TAGS="${{ github.event.inputs.tags }}"
          IFS=',' read -ra TAG_ARRAY <<< "$TAGS"
          
          for TAG in "${TAG_ARRAY[@]}"; do
            TAG=$(echo "$TAG" | xargs)  # trim whitespace
            echo "Creating/updating release for tag: $TAG"
            
            # Create tag if it doesn't exist
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag -f "$TAG"
            git push origin "$TAG" -f
            
            # Create/update release
            gh release delete "$TAG" --yes 2>/dev/null || true
            gh release create "$TAG" \
              --title "Release $TAG" \
              --notes "Release $TAG" \
              release/sto-plugin-linux-amd64.zst \
              release/sto-plugin-linux-arm64.zst \
              release/sto-plugin-darwin-arm64.zst
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
