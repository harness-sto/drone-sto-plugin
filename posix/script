#!/bin/bash

# Detect OS
OS="$(uname -s)"
case "${OS}" in
    Linux*)     OS_NAME="linux";;
    Darwin*)    OS_NAME="darwin";;
    *)          echo "Unknown OS: ${OS}"; exit 1;;
esac

# Detect Architecture
ARCH="$(uname -m)"
case "${ARCH}" in
    x86_64)     ARCH_NAME="amd64";;
    amd64)      ARCH_NAME="amd64";;
    aarch64)    ARCH_NAME="arm64";;
    arm64)      ARCH_NAME="arm64";;
    *)          echo "Unknown architecture: ${ARCH}"; exit 1;;
esac

if [ "$OS_NAME" = "darwin" ]; then
    # macOS uses /private/tmp
    export RESULTS_PATH="${RESULTS_PATH:-/private/tmp/addon/tmp}"
    export ADDON_PATH="${ADDON_PATH:-/private/tmp/addon/results}"
    export CUSTOMER_ARTIFACTS_PATH="${CUSTOMER_ARTIFACTS_PATH:-/private/tmp/shared/customer_artifacts}"
else
    # Linux uses /tmp or /addon (Docker standard)
    export RESULTS_PATH="${RESULTS_PATH:-/tmp/addon/tmp}"
    export ADDON_PATH="${ADDON_PATH:-/tmp/addon/results}"
    export CUSTOMER_ARTIFACTS_PATH="${CUSTOMER_ARTIFACTS_PATH:-/tmp/shared/customer_artifacts}"
fi


# Construct binary name
BINARY="sto-plugin-${OS_NAME}-${ARCH_NAME}"

# Use CLONE_CACHE_PATH if set, otherwise fallback to find
echo "BINARY_ROOT_DIR: ${CLONE_CACHE_PATH}"
if [ -n "$CLONE_CACHE_PATH" ] && [ -x "${CLONE_CACHE_PATH}/data/posix/${BINARY}" ]; then
    export BINARY_PATH="${CLONE_CACHE_PATH}/data/posix/${BINARY}"
else
    # Fallback: search for binary using find
    SEARCH_ROOTS=()
    if [ "$OS_NAME" = "darwin" ]; then
        [ -d /Users/anka/.cache ] && SEARCH_ROOTS+=("/Users/anka/.cache")
    else
        [ -d /home/harness/.cache ] && SEARCH_ROOTS+=("/home/harness/.cache")
        [ -d /home/ubuntu/.cache ] && SEARCH_ROOTS+=("/home/ubuntu/.cache")
    # Fallback to the broader /home tree only if no specific home directories were found
        [ "${#SEARCH_ROOTS[@]}" -eq 0 ] && [ -d /home ] && SEARCH_ROOTS+=("/home")
    fi

    if [ "${#SEARCH_ROOTS[@]}" -gt 0 ]; then
        echo "BINARY_ROOT_DIR not set, searching dir: ${SEARCH_ROOTS[@]}"
        export BINARY_PATH=$(find "${SEARCH_ROOTS[@]}" \
            -path "*/data/posix/${BINARY}" -type f -print | head -n 1)
    else
        BINARY_PATH=""
    fi
fi

# Check if binary exists
if [ -z "$BINARY_PATH" ] || [ ! -x "$BINARY_PATH" ]; then
    echo "Error: ${BINARY} binary not found via search path"
    exit 1
fi

# Execute the binary
exec "$BINARY_PATH" --run-strategy single-container
