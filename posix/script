#!/bin/bash

# Detect OS
OS="$(uname -s)"
case "${OS}" in
    Linux*)     OS_NAME="linux";;
    Darwin*)    OS_NAME="darwin";;
    *)          echo "Unknown OS: ${OS}"; exit 1;;
esac

# Detect Architecture
ARCH="$(uname -m)"
case "${ARCH}" in
    x86_64)     ARCH_NAME="amd64";;
    amd64)      ARCH_NAME="amd64";;
    aarch64)    ARCH_NAME="arm64";;
    arm64)      ARCH_NAME="arm64";;
    *)          echo "Unknown architecture: ${ARCH}"; exit 1;;
esac

if [ "$OS_NAME" = "darwin" ]; then
    # macOS uses /private/tmp
    export RESULTS_PATH="${RESULTS_PATH:-/private/tmp/addon/tmp}"
    export ADDON_PATH="${ADDON_PATH:-/private/tmp/addon/results}"
    export CUSTOMER_ARTIFACTS_PATH="${CUSTOMER_ARTIFACTS_PATH:-/private/tmp/shared/customer_artifacts}"
else
    # Linux uses /tmp or /addon (Docker standard)
    export RESULTS_PATH="${RESULTS_PATH:-/tmp/addon/tmp}"
    export ADDON_PATH="${ADDON_PATH:-/tmp/addon/results}"
    export CUSTOMER_ARTIFACTS_PATH="${CUSTOMER_ARTIFACTS_PATH:-/tmp/shared/customer_artifacts}"
fi


# Construct binary name
BINARY="sto-plugin-${OS_NAME}-${ARCH_NAME}"
SEARCH_ROOTS=()
if [ "$OS_NAME" = "darwin" ]; then
    [ -d /Users ] && SEARCH_ROOTS+=("/Users")
else
    [ -d /home/harness ] && SEARCH_ROOTS+=("/home/harness")
    [ -d /home/ubuntu ] && SEARCH_ROOTS+=("/home/ubuntu")
    [ "${#SEARCH_ROOTS[@]}" -eq 0 ] && [ -d /home ] && SEARCH_ROOTS+=("/home")
fi

if [ "${#SEARCH_ROOTS[@]}" -gt 0 ]; then
    export BINARY_PATH=$(sudo find "${SEARCH_ROOTS[@]}" \
        -path "*/harness/*" -prune -o \
        -path "*/.cache/*" -type f -name "${BINARY}" -print | head -n 1)
else
    BINARY_PATH=""
fi

# Check if binary exists
if [ -z "$BINARY_PATH" ] || [ ! -x "$BINARY_PATH" ]; then
    echo "Error: ${BINARY} binary not found via search path"
    exit 1
fi

# Execute the binary
exec "$BINARY_PATH" --run-strategy single-container
